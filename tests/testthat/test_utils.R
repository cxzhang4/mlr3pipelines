context("utils")

test_that("task_filter_ex - Basic functionality", {
  task = mlr_tasks$get("iris")

  rowidx = as.integer(c(1, 2, 3, 2, 1, 2, 3, 2, 1))  # annoying and unnecessary mlr3 type strictness

  # Equal to task$filter() in case of no duplicates
  tfiltered_ex = task_filter_ex(task$clone(), unique(rowidx))
  tfiltered = task$clone()$filter(unique(rowidx))
  expect_equal(tfiltered_ex$data(), tfiltered$data())

  # With duplicates
  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))

  # After selecting columns
  task$select(c("Petal.Length", "Petal.Width"))
  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))
})

test_that("task_filter_ex - filtered trailing rows", {
  task = as_task_classif(rbind(iris, iris, iris), target = "Species", id = "test")
  task$filter(301:450)

  rowidx = as.integer(300 + c(1, 2, 3, 2, 1, 2, 3, 2, 1, 4))

  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))
})

test_that("task_filter_ex - task with column role group", {
  task = mlr_tasks$get("iris")
  task$cbind(data.frame(grp = rep(c("A", "A", "B", "C", "D"), 30)))
  task$set_col_roles("grp", "group")

  rowidx = as.integer(c(1, 2, 3, 2, 1, 2, 3, 2, 1, 4))

  # Basic test
  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))
  expect_equal(
    table(tfiltered$groups$group),
    table(c("A", "A", "B", "A_1", "A_1", "A_2", "B_1", "A_3", "A_2", "C"))
  )

  # Name collision
  task$cbind(data.frame(grp = rep(c("A", "A_1", "B", "C", "D"), 30)))
  task$set_col_roles("grp", "group")

  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))
  expect_equal(
    tfiltered$groups$group,
    c("A", "A_1", "B", "A_1_1", "A_2", "A_1_2", "B_1", "A_1_3", "A_3", "C")
  )
})

test_that("task_filter_ex - changed row_roles$use", {
  task = mlr_tasks$get("iris")

  rowidx = as.integer(c(1, 2, 3, 2, 1, 2, 3, 2, 1))

  task$row_roles$use = seq(1, 50)
  tfiltered = task_filter_ex(task$clone(), rowidx)
  expect_equal(tfiltered$data(), task$data(rows = rowidx))

  task$row_roles$use = c(seq(1, 50), seq(1, 20))
  tfiltered = task_filter_ex(task$clone(), 50L + rowidx)
  expect_equal(tfiltered$data(), task$data(rows = 50L + rowidx))
})

test_that("task_filter_ex - group renaming in changed row_roles$use", {
  df = data.frame(
    target = 1:3,
    x = 1:3,
    grp = c("a", "b", "c")
  )
  task = TaskRegr$new(id = "test", backend = df, target = "target")
  task$set_col_roles("grp", "group")
  task$row_roles$use = c(1, 1, 2, 2, 3)

  # Correct tests: ordering of groups
  # add test for when a non-existing row_id is passed to row_ids in task_filter_ex()
  # should generate empty data.table in $data() or ignore it (like in task$filter())

  tfiltered = task_filter_ex(task$clone(), c(1L, 1L, 2L, 2L, 3L))
  expect_equal(table(tfiltered$row_ids), table(1:5))
  expect_equal(table(tfiltered$groups$group), table(c("a", "b", "c", "a", "b")))

  tfiltered = task_filter_ex(task$clone(), c(1L, 1L, 1L, 1L, 2L, 2L, 3L))
  expect_equal(table(tfiltered$row_ids), table(1:7))
  expect_equal(table(tfiltered$groups$group), table(c("a", "b", "c", "a", "b", "a_1", "a_1")))

  tfiltered = task_filter_ex(task$clone(), c(1L, 1L, 1L, 1L, 3L))
  expect_equal(table(tfiltered$row_ids), table(c(1, 3, 4, 5, 6)))
  expect_equal(table(tfiltered$groups$group), table(c("a", "c", "a", "a_1", "a_1")))

  tfiltered = task_filter_ex(task$clone(), 3L)
  expect_equal(table(tfiltered$row_ids), table(3))
  expect_equal(table(tfiltered$groups$group), table("c"))

  # What do we want in this case?
  # We have row 2 twice in row_roles$use
  # However, we expect only one row to be returned
  # so in this case we only want one row, with unchanged group
  # Does this never occur?
  tfiltered = task_filter_ex(task$clone(), 2L)
  expect_equal(tfiltered$row_ids, 2)
  expect_equal(table(tfiltered$groups$group), table("b"))

  # What do we want in this case?
  # 1 is occurs 3 times in row_ids, but 2 times in task$row_roles$use -> not exact multiple
  # Does this never occur?
  tfiltered = task_filter_ex(task$clone(), c(1L, 1L, 1L, 3L))
  expect_equal(table(tfiltered$row_ids), table(c(1, 3, 4, 5)))
  expect_equal(table(tfiltered$groups$group), table(c("a", "c", "a", "a_1")))


  tfiltered = task_filter_ex(task$clone(), c(1L, 1L, 1L, 1L, 3L, 1L, 1L))
  expect_equal(table(tfiltered$row_ids), table(c(1, 3, 4, 5, 6, 7, 8)))
  expect_equal(table(tfiltered$groups$group), table(c("a", "c", "a", "a_1", "a_1", "a_2", "a_2")))
})

# test case
df = data.frame(
  target = 1:3,
  x = 1:3,
  grp = c("a", "b", "c")
)
task = TaskRegr$new(id = "test", backend = df, target = "target")
task$set_col_roles("grp", "group")
task$row_roles$use = c(1, 1, 2, 2, 3, 3)

# 1 occurs more often than in task$row_roles$use, exact multiple
# 2 occurs more often than in task$row_roles$use, not exact multiple
# 3 occurs less often than in task$row_roles$use
# 4 is a non-existing row_id (IGNORE this for now)
row_ids = c(1, 1, 1, 1, 2, 2, 2, 3)
tfiltered = task_filter_ex(task$clone(), row_ids)

df = data.frame(
  target = 1:3,
  x = 1:3,
  grp = c("a", "b", "c")
)
task = TaskRegr$new(id = "test", backend = df, target = "target")
task$set_col_roles("grp", "group")
tfiltered = task_filter_ex(task$clone(), c(1, 1, 1, 1, 2, 3))
tfiltered$groups
